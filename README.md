# Прокси-сервер для управления хранилищами 1С

Позволяет структурировать работу с множественными хранилищами 1С и применять к ним ряд контрольных операций.

Какие именно операции можно применить - зависит от команды разработчиков, от создаваемой системы.

## Проверки формата комментариев в хранилище конфигураций 1С

### Назначение

Простой инструмент для контроля формата комментариев, которые разработчики указывают при помещении изменений в хранилище. Это прокси-сервер nginx, который с помощью кода на Lua анализирует запросы и выдает `400 Bad Request` в случае, если комментарий к версии хранилища не указан или указан не по формату. Проверка осуществляется не только при помещении изменений, но и при редактировании версий хранилища "задним числом".

По умолчанию реализована одновременно строгая и наивная проверка комментария. Корректный комментарий:

- не пустой
- начинается на `#`, после чего должны следовать либо 5 цифр, либо строка `"нетзадачи"`
- содержит два перевода строки

Примеры корректных комментариев:

```md
#12345 Обработка заполнения ТЧ "Товары"

Добавлена обработка заполнения ТЧ "Товары" документа "Реализация товаров и услуг"
```

```md
#нетзадачи

Тех. долг
```

## Синхронизация коммита в GIT по требованию

### Назначение

При помещении кода в хранилище отправляет http-запрос на указанный адрес.

Зачастую совместно с хранилищем испольщуются инструменты синхронизации с GIT, например, [gitsync](https://github.com/oscript-library/gitsync). Обычно синхронизацию запускают по какому-то таймеру, этот таймер нужно где-то организовать и правильно настроить, чтобы лишние действия не выполнялись ночью, в выходные и праздники.

Данная настройка позволяет запускать синхронизацию только тогда, когда код реально изменен. Кроме того, можно организовать любую другую логику, поскольку реализация веб-хука остается полностью на вашей фантазии.

## Надежность

Работоспособность решения проверена на конфигурациях размера ERP 2.4 при активной работе 10+ разработчиков, в том числе в режиме подключения пустой конфигурации к хранилищу.

# Использование

## Переключение на внешний сервер хранилищ

 Если сервер хранилищ 1С будет внешним, а не встроенным в даннное решение docker-контейнером, то нужно закомментировать в файле docker-compose.yml сервис `crs`

```yml
services:
  # crs:
  #  image: evilbeaver/crs:8.3.17.1989      
```

Для целей отладки на локальной машине - данные строки рекомендуется оставить.
Далее, нужно внести изменения в файл `data/apache/ccr/*.1ccr` и прописать там путь к реальному серверу хранилищ 1С.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<repository connectString="tcp://crs:1542"/>
```

## Настройка команд разработки и систем

Данное решение позволяет организовать управляемое именование хранилищ по шаблону `<команда>/<система>`. По умолчанию, 1С разрешает создавать папки хранилищ на сервере неконтролируемо. Любая команда разработки может плодить хранилища, как вздумается.

В данном решении сервер Apache контролирует путь доступа и разрешает обращение только в известные папки хранилищ.

Для организации доступа предназначен каталог `data/apache/*` Каждая папка в этом каталоге (за исключением системной папки ccr) может иметь произвольное имя, которое станет частью адреса хранилища. Чаще всего, это название отдела, группы, команды разработки.

Внутри группы могут находиться **системы** - конкретные каталоги хранилищ 1С. Например:

```
http://depot-server/otdel_84/erp2
http://depot-server/rnd/buh3
```
Обратите внимание, в адресе отсутствует системный файл 1С *.1ccr. Практика показывает, что разработчикам неудобно запоминать синтаксис адресной строки хранилища. В данном случае адрес стал человекочитаемым. Для такой схемы именования каталог `data/apache` должен содержать 2 папки:

* otdel_84
  * .htaccess
* rnd
  * .htaccess

  Файлы `.htaccess` внутри этих каталогов должны содержать правила перезаписи адреса. Укажите в них адреса реальных хранилищ, по примеру файла `namespace/.htaccess`

```
RewriteEngine On
RewriteBase /ccr
RewriteRule ^system$ 8.3.17.1989.1ccr/namespace/system [L]
RewriteRule ^system2$ 8.3.19.2085.1ccr/namespace/system2 [L]
```

Разделение файлов .htaccess по разным папкам позволяет удобно контролировать, какие хранилища есть у каких команд разработки и на каких версиях платформы они работают.

## Настройка пре-коммит действий

На данный момент поддерживаются 2 действия: перед коммитом и после коммита. Действия описываются в файлах `data/nginx/rewrite.lua` и `data/nginx/log.lua` соответственно.

Все действия - это модули lua, которые хранятся на сервере nginx и попадают туда при сборке контейнера nginx из папки `nginx/lualib`. Добавляйте туда свои модули, если хотите добавить новые проверки/действия.

Для того, чтобы задействовать, например, фильтр пустых коммитов, пропишите в файле `data/nginx/rewrite.lua` код проверки

```lua
local filter = require "v8.commitFilter"
m.apply(nil)
```

В качестве параметра метода apply можно передать регулярное выражение, которое будет проверять текст коммита на соблюдение корпоративных правил комментирования закладок.

Поскольку файл rewrite.lua настраивается на уровне location в nginx - вы можете применять разные правила обработки для разных команд разработки, поскольку, напоминаем, адрес хранилища состоит из названия команды и названия разрабатываемой системы. Т.е. для адреса **team1/system1** может быть настроен свой location со своими правилами обработки.

## Запуск

- выполнить `docker-compose up -d`
- открыть Конфигуратор, закрыть хранилище, открыть хранилище, вместо адреса реального хранилища указать `прокси:порт`

БЫЛО: `http://srv-app-01/CRServer/repository.1ccr/ERP_Master`

СТАЛО: `http://proxy-server/team_erp/ERP_Master`

## Ссылки

- [commitHook](https://github.com/asosnoviy/commitHook)
- [OpenResty](https://openresty.org/)
